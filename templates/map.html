{% extends 'base.html' %}

{% block title %}Mapa Interactivo{% endblock %}

{% block head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<style>
    .leaflet-popup-content-wrapper { background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .leaflet-popup-content { margin: 12px !important; font-size: 14px; font-weight: 600; color: #333; }
    .leaflet-popup-tip-container { display: none; }
    .leaflet-popup-close-button { color: #333 !important; padding: 8px !important; }
    .leaflet-popup-close-button:hover { background-color: #f3f4f6; }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
</style>
{% endblock %}

{% block content %}
<div id="app" class="pt-24">
    {% raw %}
    <!-- Loading Spinner -->
    <transition name="fade">
        <div v-if="isLoading" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[1000]">
            <div class="text-center">
                <i class="fa-solid fa-spinner fa-spin fa-3x text-blue-600"></i>
                <p class="mt-4 text-lg font-semibold text-gray-700">Cargando rutas...</p>
            </div>
        </div>
    </transition>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1 bg-white rounded-2xl shadow-lg p-6 h-max space-y-6">
                <div class="border border-gray-200 rounded-xl p-4">
                    <h2 class="font-bold text-xl mb-2 flex items-center"><i class="fa-solid fa-street-view text-green-500 mr-2"></i>Tu Ubicación</h2>
                    <div class="bg-gray-50 p-3 rounded-lg text-sm">
                        <p v-if="userAddress">{{ userAddress }}</p>
                        <p v-else class="text-gray-500 italic">Obteniendo tu ubicación...</p>
                    </div>
                </div>

                <div class="border border-gray-200 rounded-xl p-4">
                    <h2 class="font-bold text-xl mb-2 flex items-center"><i class="fa-solid fa-magnifying-glass text-purple-500 mr-2"></i>Buscar Parada</h2>
                    <div class="relative">
                        <input type="text" v-model="stopQuery" placeholder="Escribe el nombre de una parada..." class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                        <transition name="fade">
                            <ul v-if="filteredStops.length > 0 && stopQuery" class="absolute z-20 w-full bg-white border border-gray-200 rounded-lg mt-1 max-h-60 overflow-y-auto shadow-xl">
                                <li v-for="stop in filteredStops" :key="stop.name" @click="showStopAndRoutes(stop)" class="p-3 cursor-pointer hover:bg-gray-100 transition-colors">
                                    {{ stop.name }}
                                </li>
                            </ul>
                        </transition>
                    </div>
                </div>

                <div class="border border-gray-200 rounded-xl p-4">
                    <h2 class="font-bold text-xl mb-2 flex items-center"><i class="fa-solid fa-route text-blue-500 mr-2"></i>Todas las Rutas</h2>
                    <div v-if="allRoutes.length > 0" class="space-y-2">
                        <div v-for="route in allRoutes" :key="route.id" class="bg-gray-50 border border-gray-200 rounded-lg overflow-hidden">
                            <div @click="toggleRoute(route.id)" class="p-3 cursor-pointer flex justify-between items-center hover:bg-gray-100 transition-colors">
                                <h3 class="font-semibold flex items-center"><span class="w-4 h-4 rounded-full mr-3" :style="{ backgroundColor: route.color }"></span>{{ route.name }}</h3>
                                <i class="fa-solid transition-transform duration-300" :class="{'fa-chevron-down': expandedRouteId !== route.id, 'fa-chevron-up': expandedRouteId === route.id}"></i>
                            </div>
                            <div v-show="expandedRouteId === route.id" class="p-3 border-t border-gray-200 bg-white">
                                <button @click="drawRoute(route)" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition mb-3 flex items-center justify-center space-x-2">
                                    <i class="fa-solid fa-eye"></i><span>Ver ruta completa</span>
                                </button>
                                <h4 class="font-bold mb-2 mt-4">Paradas:</h4>
                                <ul class="space-y-1 max-h-48 overflow-y-auto text-sm">
                                    <li v-for="(stop, index) in route.stops" :key="index" @click="drawRoute(route, stop)" class="p-2 rounded-md cursor-pointer hover:bg-gray-100 flex items-center">
                                        <i class="fa-solid fa-map-pin mr-2 text-gray-400"></i><span>{{ stop.name }}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 rounded-2xl shadow-lg overflow-hidden">
                <div id="map" class="w-full h-[85vh]"></div>
            </div>

        </div>
    </div>
    {% endraw %}
</div>

<script>
    const { createApp } = Vue;
    createApp({
        data() {
            return {
                map: null, isLoading: true, userLocation: null, userAddress: 'No disponible',
                userMarker: null, routeLayer: null, recommendationLayer: null,
                allRoutes: [], allStops: [], stopQuery: '', expandedRouteId: null,
            }
        },
        computed: {
            filteredStops() {
                if (!this.stopQuery) return [];
                return this.allStops.filter(stop => stop.name.toLowerCase().includes(this.stopQuery.toLowerCase()));
            }
        },
        mounted() {
            this.initMap();
            this.fetchAllRoutesAndStops();
        },
        methods: {
            initMap() {
                this.map = L.map('map', { zoomControl: false }).setView([19.8151, -97.3594], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(this.map);
                L.control.zoom({ position: 'bottomright' }).addTo(this.map);
            },
            async fetchAllRoutesAndStops() {
                this.isLoading = true;
                try {
                    const response = await fetch('/api/routes');
                    const data = await response.json();
                    if (response.ok) {
                        this.allRoutes = data;
                        const stops = new Map();
                        this.allRoutes.forEach(route => {
                            route.stops.forEach(stop => {
                                const key = stop.name.toLowerCase();
                                if (stops.has(key)) { stops.get(key).routeIds.push(route.id); }
                                else { stops.set(key, { name: stop.name, lat: stop.lat, lon: stop.lon, routeIds: [route.id] }); }
                            });
                        });
                        this.allStops = Array.from(stops.values());
                        this.getCurrentLocation();
                    } else { console.error("Error fetching routes:", data.error); }
                } catch (error) { console.error("Error fetching routes:", error); }
                finally { this.isLoading = false; }
            },
            clearLayers() {
                if (this.routeLayer) this.map.removeLayer(this.routeLayer);
                if (this.recommendationLayer) this.map.removeLayer(this.recommendationLayer);
                this.routeLayer = null;
                this.recommendationLayer = null;
            },
            toggleRoute(routeId) { this.expandedRouteId = this.expandedRouteId === routeId ? null : routeId; },
            drawRoute(route, highlightedStop = null) {
                this.clearLayers();
                const layers = [];
                
                // Dibujar la línea de la ruta
                if (route.coordinates && route.coordinates.length > 0) {
                    const polyline = L.polyline(route.coordinates, { 
                        color: route.color || '#FF0A0A', 
                        weight: 5, 
                        opacity: 0.8 
                    });
                    layers.push(polyline);
                }
                
                // Dibujar las paradas
                if (route.stops && route.stops.length > 0) {
                    route.stops.forEach((stop, index) => {
                        let icon, zIndexOffset = 0;
                        if (highlightedStop && stop.name === highlightedStop.name) {
                            icon = L.divIcon({ html: '<i class="fa-solid fa-location-dot fa-3x text-red-600"></i>', className: '', iconSize: [36, 36] });
                            zIndexOffset = 1000;
                        } else if (index === 0) {
                            icon = L.divIcon({ html: `<i class="fa-solid fa-bus fa-2x" style="color: ${route.color || '#FF0A0A'}"></i>`, className: '', iconSize: [24, 24] });
                        } else if (index === route.stops.length - 1) {
                            icon = L.divIcon({ html: '<i class="fa-solid fa-flag-checkered fa-2x"></i>', className: '', iconSize: [24, 24] });
                        } else {
                            icon = L.divIcon({ html: `<div class="w-3 h-3 bg-white rounded-full ring-2" style="ring-color: ${route.color}"></div>`, className: '' });
                        }
                        layers.push(L.marker([stop.lat, stop.lon], { icon, zIndexOffset }).bindPopup(stop.name));
                    });
                }
                
                // Mostrar las capas en el mapa
                if (layers.length > 0) {
                    this.routeLayer = L.featureGroup(layers).addTo(this.map);
                    this.map.fitBounds(this.routeLayer.getBounds(), { padding: [50, 50] });
                } else if (route.coordinates && route.coordinates.length > 0) {
                    // Si solo hay coordenadas sin paradas, centrar en las coordenadas
                    const bounds = L.latLngBounds(route.coordinates);
                    this.map.fitBounds(bounds, { padding: [50, 50] });
                }
            },
            getCurrentLocation() {
                navigator.geolocation.getCurrentPosition(pos => {
                    this.userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                    if (this.userMarker) this.map.removeLayer(this.userMarker);
                    const userIcon = L.divIcon({ html: '<i class="fa-solid fa-street-view fa-2x text-green-600"></i>', className: '', iconSize: [24, 24] });
                    this.userMarker = L.marker([this.userLocation.lat, this.userLocation.lon], { icon: userIcon }).addTo(this.map).bindPopup('<b>Tu ubicación</b>');
                    this.map.setView([this.userLocation.lat, this.userLocation.lon], 15);
                    fetch(`/api/reverse-geocode?lat=${this.userLocation.lat}&lon=${this.userLocation.lon}`)
                        .then(res => res.json()).then(data => { this.userAddress = data.address; });
                    this.findAndShowNearestStop();
                }, () => { this.userAddress = 'No se pudo obtener la ubicación.'; });
            },
            findAndShowNearestStop() {
                if (!this.userLocation || this.allStops.length === 0) return;
                let nearestStop = null, minDistance = Infinity;
                this.allStops.forEach(stop => {
                    const distance = this.haversine(this.userLocation.lat, this.userLocation.lon, stop.lat, stop.lon);
                    if (distance < minDistance) { minDistance = distance; nearestStop = stop; }
                });
                if (nearestStop) {
                    const layers = [];
                    const nearestIcon = L.divIcon({ html: '<i class="fa-solid fa-person-walking-arrow-right fa-3x text-cyan-500"></i>', className: '', iconSize: [36, 36] });
                    const stopMarker = L.marker([nearestStop.lat, nearestStop.lon], { icon: nearestIcon, zIndexOffset: 2000 })
                        .bindPopup(`<b>Parada más cercana:</b><br>${nearestStop.name}<br>(${minDistance.toFixed(2)} km)`);
                    layers.push(stopMarker);
                    const line = L.polyline([[this.userLocation.lat, this.userLocation.lon], [nearestStop.lat, nearestStop.lon]], { color: '#06b6d4', dashArray: '5, 10', weight: 3 });
                    layers.push(line);
                    if(this.recommendationLayer) this.map.removeLayer(this.recommendationLayer);
                    this.recommendationLayer = L.featureGroup(layers).addTo(this.map);
                    stopMarker.openPopup();
                }
            },
            showStopAndRoutes(stop) {
                this.clearLayers();
                const associatedRoutes = this.allRoutes.filter(r => stop.routeIds.includes(r.id));
                if (associatedRoutes.length === 0) return;
                const layers = [];
                associatedRoutes.forEach(route => {
                    if (route.coordinates && route.coordinates.length > 0) {
                        layers.push(L.polyline(route.coordinates, { color: route.color || '#FF0A0A', weight: 5, opacity: 0.8 }));
                    }
                    route.stops.forEach(s => {
                        if (s.name.toLowerCase() !== stop.name.toLowerCase()) {
                            const stopIcon = L.divIcon({ html: `<div class="w-3 h-3 bg-white rounded-full ring-2" style="ring-color: ${route.color}"></div>`, className: '' });
                            layers.push(L.marker([s.lat, s.lon], { icon: stopIcon }).bindPopup(s.name));
                        }
                    });
                });
                const highlightIcon = L.divIcon({ html: '<i class="fa-solid fa-map-pin fa-3x text-purple-600"></i>', className: '', iconSize: [36, 36] });
                const highlightMarker = L.marker([stop.lat, stop.lon], { icon: highlightIcon, zIndexOffset: 1000 }).bindPopup(`<b>${stop.name}</b>`);
                layers.push(highlightMarker);
                this.routeLayer = L.featureGroup(layers).addTo(this.map);
                this.map.fitBounds(this.routeLayer.getBounds(), { padding: [50, 50] });
                highlightMarker.openPopup();
                this.stopQuery = '';
            },
            haversine(lat1, lon1, lat2, lon2) {
                const R = 6371, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }
        }
    }).mount('#app');
</script>
{% endblock %}