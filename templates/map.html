<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CombiMap - Mapa Interactivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
</head>
<body class="bg-gray-100">

    {% raw %}
    <div id="app" class="container mx-auto p-4 md:p-8">
        <a href="/" class="text-blue-600 hover:underline mb-4 inline-block">&larr; Volver a la página principal</a>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Panel de Control Izquierdo -->
            <div class="md:col-span-1 bg-white shadow-lg rounded-2xl p-6 h-max">
                <div class="mb-6">
                    <h2 class="font-bold underline text-xl mb-2">Partida</h2>
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <p v-if="userAddress">{{ userAddress }}</p>
                        <p v-else class="text-gray-500 italic">Obteniendo tu ubicación...</p>
                    </div>
                </div>

                <div>
                    <h2 class="font-bold underline text-xl mb-2">Destino</h2>
                    <div class="relative">
                        <input type="text" v-model="destinationQuery" placeholder="Escribe una parada de destino..." class="w-full p-3 border-2 rounded-md">
                        <ul v-if="filteredStops.length > 0 && destinationQuery" class="absolute z-10 w-full bg-white border rounded-md mt-1 max-h-60 overflow-y-auto shadow-lg">
                            <li v-for="stop in filteredStops" :key="stop.id" @click="selectDestination(stop)" class="p-3 cursor-pointer hover:bg-gray-100">
                                {{ stop.name }}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2 bg-white shadow-lg rounded-2xl p-2 border border-gray-300">
                <h2 class="font-bold text-xl text-center p-2">Mapa Interactivo</h2>
                <div id="map" class="w-full h-[75vh] rounded-xl"></div>
                <div v-if="nearestStopInfo" class="p-4 text-center bg-gray-50 rounded-b-xl">
                    <p>Para llegar a <span class="font-bold">{{ selectedDestination.name }}</span>, tu parada más cercana es <span class="font-bold text-blue-600">{{ nearestStopInfo.name }}</span> (aprox. {{ nearestStopInfo.distance.toFixed(2) }} km).</p>
                </div>
            </div>

        </div>
    </div>
    {% endraw %}

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    map: null,
                    allStops: [],
                    userLocation: null,
                    userAddress: 'No disponible',
                    destinationQuery: '',
                    selectedDestination: null,
                    nearestStopInfo: null,
                    activeLayers: [],
                }
            },
            computed: {
                filteredStops() {
                    if (!this.destinationQuery) return [];
                    return this.allStops.filter(stop => 
                        stop.name.toLowerCase().includes(this.destinationQuery.toLowerCase())
                    );
                }
            },
            mounted() {
                this.initMap();
                this.fetchAllStops();
                this.getCurrentLocation();
            },
            methods: {
                initMap() {
                    this.map = L.map('map', { zoomControl: false }).setView([19.8151, -97.3594], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(this.map);
                    L.control.zoom({ position: 'bottomright' }).addTo(this.map);
                },
                fetchAllStops(){
                    fetch('/api/stops').then(res => res.json()).then(data => { this.allStops = data; });
                },
                clearMap() {
                    this.activeLayers.forEach(layer => this.map.removeLayer(layer));
                    this.activeLayers = [];
                },
                getCurrentLocation() {
                    navigator.geolocation.getCurrentPosition(pos => {
                        this.userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                        const userIcon = L.divIcon({ html: '<i class="fa-solid fa-street-view fa-2x text-green-600"></i>', className: '', iconSize: [24, 24] });
                        const userMarker = L.marker([this.userLocation.lat, this.userLocation.lon], {icon: userIcon}).addTo(this.map).bindPopup('<b>Tu ubicación (Origen)</b>');
                        this.activeLayers.push(userMarker);
                        this.map.setView([this.userLocation.lat, this.userLocation.lon], 15);
                        fetch(`/api/reverse-geocode?lat=${this.userLocation.lat}&lon=${this.userLocation.lon}`)
                            .then(res => res.json())
                            .then(data => { this.userAddress = data.address; });
                    }, () => {
                        this.userAddress = 'No se pudo obtener la ubicación.';
                    });
                },
                selectDestination(stop) {
                    if (!this.userLocation) { alert('Por favor, permite el acceso a tu ubicación.'); return; }
                    this.selectedDestination = stop;
                    this.destinationQuery = ''

                    const originString = `Mi ubicación (${this.userLocation.lat}, ${this.userLocation.lon})`;
                    const params = new URLSearchParams({ origin: originString, destination: stop.name });
                    
                    fetch(`/api/search?${params.toString()}`)
                        .then(res => res.json())
                        .then(routes => {
                            if (routes && routes.length > 0) {
                                const bestRoute = routes[0];
                                this.drawFoundRoute(bestRoute);
                            } else {
                                alert("No se encontró una ruta directa a ese destino.");
                            }
                        });
                },
drawFoundRoute(route) {
                    this.clearMap();

                    fetch(`/api/route/${route.id}/nearest-stop?lat=${this.userLocation.lat}&lon=${this.userLocation.lon}`)
                        .then(res => res.json())
                        .then(stopData => {
                            if (stopData.error) { return; }
                            this.nearestStopInfo = stopData;
                            this.nearestStopInfo.distance = this.haversine(this.userLocation.lat, this.userLocation.lon, stopData.lat, stopData.lon);

                            const layers = [];

                            // 1. Marcador de Usuario
                            const userIcon = L.divIcon({ html: '<i class="fa-solid fa-street-view fa-2x text-green-600"></i>', className: '', iconSize: [24, 24] });
                            const userMarker = L.marker([this.userLocation.lat, this.userLocation.lon], { icon: userIcon }).bindPopup('<b>Origen</b>');
                            layers.push(userMarker);

                            // 2. Polilínea de la ruta
                            const routePolyline = L.polyline(route.coordinates, { color: route.color || '#e67e22' });
                            layers.push(routePolyline);

                            // 3. Marcadores de paradas
                            route.stops.forEach(stop => {
                                if (stop.name === stopData.name) { // Parada más cercana
                                    const nearestIcon = L.divIcon({ html: '<i class="fa-solid fa-bus fa-2x text-blue-600"></i>', className: '', iconSize: [24, 24] });
                                    layers.push(L.marker([stop.lat, stop.lon], { icon: nearestIcon, zIndexOffset: 1000 }).bindPopup(`<b>Parada más cercana</b><br>${stop.name}`));
                                } else if (stop.name === this.selectedDestination.name) { // Destino
                                    const destIcon = L.divIcon({ html: '<i class="fa-solid fa-flag-checkered fa-2x text-red-600"></i>', className: '', iconSize: [24, 24] });
                                    layers.push(L.marker([stop.lat, stop.lon], { icon: destIcon, zIndexOffset: 1000 }).bindPopup(`<b>Destino</b><br>${stop.name}`));
                                } else { // Parada intermedia
                                    const stopIcon = L.divIcon({ html: '<div class="bg-gray-400 w-2 h-2 rounded-full border-2 border-white"></div>', className: '', iconSize: [8, 8] });
                                    layers.push(L.marker([stop.lat, stop.lon], { icon: stopIcon }).bindPopup(stop.name));
                                }
                            });

                            // 4. Añadir todas las capas al mapa en un solo grupo
                            const featureGroup = L.featureGroup(layers).addTo(this.map);
                            this.activeLayers.push(featureGroup);

                            // 5. Ajustar el mapa a los límites del grupo
                            this.map.fitBounds(featureGroup.getBounds(), { padding: [50, 50] });
                        });
                },
                haversine(lat1, lon1, lat2, lon2) {
                    const R = 6371, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
                    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                }
            }
        }).mount('#app');
    </script>
</body>
</html>